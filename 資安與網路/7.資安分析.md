> References
> - Module 24. Technologies and Protocol. CyberOps Associate Training from Cisco Networking Academy.
> - Module 25. Network Security Data. CyberOps Associate Training from Cisco Networking Academy.
> - Module 26. Evaluating Alerts. CyberOps Associate Training from Cisco Networking Academy.
> - Module 27. Working with Network Security Data. CyberOps Associate Training from Cisco Networking Academy.
> - Module 28. Digital Forensics and Incident Analysis and Response. CyberOps Associate Training from Cisco Networking Academy.


Socat Network utility for data transfer and tunneling (not listed in current options)
IDA Pro Option 3: Debugger for reverse engineering and malware analysis
NetStumbler Option 2: Wireless hacking tool
Helix Option 1: Forensic tool

## 7-1. 資安監控技術
- 服務/協定潛在資安問題
    | 服務 | 說明 | 對策 |
    | -- | -- | -- |
    | syslog | 駭客竄改或毀壞syslog內資料 | syslog-ng (次世代syslog), Windows Event Collector, rsyslog (Linux) |
    | NTP | 破壞時間訊息，或當作DDoS攻擊主導。使用UDP port 123。  | |
    | DNS | 連線CnC主機，加密(Base64, 8-bit binary, Hex)偽裝正常DNS查詢洩漏機敏資料。 | DNS proxy log，注意子域名是否過長、不存在。Cisco Umbrella passive DNS service |
    | HTTP (註1) | iFrame注入-網頁伺服器會載入另一個資料來源(惡意軟體)。 | Cisco Web Reputation filtering | 網頁加入SSL，變成HTTPS |
    | SMTP | 原本讓不同伺服器交換信件用，將受感染主機中的使用者資料外傳至CnC伺服器。如2014年Sony Pictures遭駭事件。 | 仍應注意外部流量。 |
    | IMAP/POP3 | 原本讓收件者取信使用，成為惡意軟體進入主機的通道 | 安全監控工具擷取受感染的郵件附件，提交至惡意軟體沙箱（sandbox）進行分析 |
    | ICMP | 判斷主機與網路結構，當作DoS攻擊的載具。</br>惡意軟體透過內部網路ICMP流量可用於資料外洩，如ICMP通道(ICMP tunneling)、LOKI漏洞。 | 阻擋進入的Echo-Request封包，防止ping探勘。 |
    - 註1. HTTPS（安全網頁傳輸）
        1. 瀏覽器向網站請求一個安全的網頁。
        2. 網站傳送「公開金鑰」和「數位憑證」給瀏覽器。
        3. 瀏覽器檢查憑證是否有效（沒過期、沒被撤銷、由信任的機構簽發）。
        4. 瀏覽器產生一把「對稱金鑰」，並用伺服器的「公開金鑰」加密後送出。
        5. 伺服器用自己的「私密金鑰」解開「對稱金鑰」。
        6. 雙方擁有相同的「對稱金鑰」。
        7. 之後雙方用這把「對稱金鑰」加密與解密資料，安全地傳輸資訊。

- 資安設定潛在資安問題
    | 設定 | 說明 | 對策 |
    | -- | -- | -- |
    | ACL | 駭客可以port掃描、滲透測試、recon，得知ACL允許的IP位址、Port、協定，讓偽造的IP位址、TCP資料段能被設備相信，連通port。 | Cisco Next Generation firewalls, Advanced Malware Protection (AMP) |
    | NAT/PAT (註2) | 位址轉換讓監控不易進行。 | NetFlow |
    | 加密/封裝/通道 | 屬於VPN技術，因不易解析封包內容，造成如DNS加密資料洩漏問題 | |
    | P2P連線 | 主要用於檔案共享、處理器共享(processor sharing)、即時訊息(instant messaging)。Napster and Gnutella、Bitcoi分散式資料庫、BitTorrent檔案共享、Webex Teams。多個IP連線建立、動態port給定都是危險的。 | |
    | Tor | 使用特殊瀏覽器(軟體平台)進行匿名連線，以The onion routing加密多層，傳輸dark net，連線只有下一跳Tor節點知道。常用於犯罪相關的dark net，或者惡意軟體的CnC通道。 | |
    | 負載平衡(load balancing) | 單一連線可能因來自不同IP，被誤判成可疑的封包、活動。</br>使用Load Balancing Manager，避免將流量傳送到不可用的資源。 | |
    - 註2. Inside/Outside、Local/Global
        - Inside Local：NAT轉換前 內網主機的私有位址
        - Inside Global：NAT轉換後 內網主機的公有位址
        - Outside Local：NAT轉換前 外部主機的「內部映射」位址(罕用)
        - Outside Global：NAT轉換後 外部主機的公有位址


## 7-2. 網路安全資料/紀錄
- 資安資料
    - 警報資料：透過IPS或IDS產生(Snort)的資料。-> Sguil/Squert in Security Onion
    - 連線資料：兩端點連線session資料，包括five tuples (來源IP、目的IP、來源port、目的port、protocol編號)，以及session ID、資料傳輸量、傳輸時間。 -> Zeek(或稱作Bro)
    - 交易資料：連線過程的封包內容。->伺服器的access log，Zeek
    - 完整封包抓取：包括連線資料、交易資料，可分析惡意軟體 -> Wireshark, Cisco Prime Infrastructure system
    - 統計資料：使用Network Behavior Analysis (NBA)或Network Behavior Anomaly Detection (NBAD)，可分析NetFlow、IPFIX的資料是否有異常並提供預測。
- 終端裝置log
    - 主機日誌(host log)：由HIDS產生(如OSSEC、Event Viewer in MS Windows、Tripwire)，可透過設置agent傳送日誌給管理主機。
        - MS Event Viewer有5種，由lsass.exe執行取得(容易被偽造，正確位置在C:\Windows\System32\lsass.exe)：Application logs, System logs, Setup logs, Security logs, Command-line logs。
        - MS事件分類有5種：Error, Warning, Information, Success Audit, Failure Audit。
    - 系統日誌(syslog)：採用IETF (RFC 5424)，透過UDP 514、TCP 5000或SSL傳輸，接收端主機(syslogd/Syslog daemon/Syslog server)。
        - syslog的組成分成3個部分(1024 bytes)：PRI (=(Facility * 8) + Severity)、HEADER(時戳與IP)、MSG。
        - 其他伺服器日誌(server log)：來自電郵主機、網頁主機、DNS proxy主機、UNIX and Linux server、Apache webserver、Microsoft Internet Information Server (IIS)。
    - SIEM
    - SOAR

- 網路行為log
    | 工具 | 說明 | 備註 |
    | -- | -- | -- |
    | 掩蓋正在進行攻擊的痕跡 | disguise traces of an ongoing exploit |
    | 隱藏內容 | conceal the contents |
    | 繞過防火牆保護 | circumvent firewall protections |
    | 透過公共設施建立網路間虛擬點對點的連線 | establishes a virtual point-to-point connection between networks over public facilities |
    | 給資安監控帶來挑戰 | present challenges to security monitoring |
    | 把流量接起來 | “stitch” flows together |
    | 封包操縱 | packet manipulation |
    | 滲透測試 | penetration testing |
    | 解決缺點 | address the shortcomings |
    | 過度依賴 | overly rely upon |
    | 給人一種虛假的安全感 | give a false sense of security |
    | 製造多種類型的漏洞 | craft a number of types of exploits |
    | 對封包抓取增加複雜性 | add complexity to packet captures |
    | 使監控複雜化 | complicate monitoring |
    | 機密資料的變動或攔截 | the alteration or interception of confidential data |
    | 存放惡意軟體 | house malicious software |
    | 受感染的DNS伺服器 | Compromised DNS Server |
    | 偽裝成子網域的Base64編碼竊取數據 | Base64-coded Exfiltrated Data Disguised as Subdomains |
    | 逃避DLP檢查 | evade basic data loss prevention (DLP) measures |
    | 偽裝資料 | camouflage the data |
    | 共用一致的時間資訊 | share consistent time information |
    | tcpdump | 顯示封包協定、"內容" | Wireshark |
    | NetFlow (nfdump) | 取得封包的來源目標IP/Port、Protocol種類、服務種類、路由器介面，存入NetFlow cache | Cisco開發Ver 9，用於IPFIX |
    | AVC系統 | 使用Cisco的Next-Generation NBAR技術，查看port和服務的行為與統計。 | Cisco開發 |
    | Content Filter Log | ESA和WSA裝置可檢查"內容"傳送syslog, FTP, SCP伺服器。</br>WSA另有ACL decision log, malware scan log, web reputation filtering log。</br>Cisco有向下鑽研，從Overview到Detailed報告頁面。 | ESA、WSA(如同web proxy) |
    | Cisco專有Syslog | 分類編號(ASA或SYS)、嚴重度、標記符號(Mnemonic) | 分成ASA裝置、IOS裝置 |
    | proxy log | 記錄轉發客戶端請求並回傳動作，可用來分析來源、檢測惡意內容，進行資料外洩防護(DLP)。 | Squid, CCProxy, Apache Traffic Server, WinGate, Cisco Umbrella |
    | 次世代防火牆(NextGen Firewal) | NGFW事件記錄包括連線、入侵、主機/端點、網路發覺、Netflow。L3以上到應用層。 | |

- 常見網路監控系統資料平台
    - ELK 
        - 全稱 Elasticsearch, Logstash, and Kibana
        - 屬於SIEM，單一介面顯示多種的網路。
        - 由開源程式碼組成，先透過Logstash或Beats取得資料(ETL技術)，以Elasticsearch儲存並分析資料，再使用Kibana可視化資料。
            - Elasticsearch是JAVA開發的平台，建立在Apache Lucene，支援REST API，使用JSON格式儲存資料，inverted index等同於DB，types等同於tables，documents等同於columns/rows。可使用Query DSL查詢資料，包括。
            - NSM資料減量(reduction)：可濾掉無法解讀內容的加密封包，也可濾掉路由協定或生成樹協定流量，廣播或多播也不須留存，安全性低的HIDS警報、嚴重度低的syslog也可不處理。
            - NSM資料正規化(normalization)：簡化相關事件的搜尋。
                - 正規化為將原始資料的數據按比例縮放至[0,1]的區間中，且不改變原本的分佈情形。標準化則會使資料的平均值為0，標準差為1，經過標準化之後，資料會較符合常態分佈，並可以減小離群值對於模型的影響。
            - NSM資料歸檔(archinving)：保存期限(retention period)，PCI DSS保存12個月，Security Onion保存30天。
            - NSM資料可視化：Kibana預設顯示過去24小時數據。
                - 其他工具：Security Onion的Squert。
    - Sguil
        - 在Security O nion中，分析警報種類的第一站。
        - 自動分類有關連的警報。
        - 資料查詢(Query)：使用Query Builder，可以查詢event.對應的項目。
        - 資料樞紐(Pivoting)：可處理其他資料來源，包括Elasticsearch的log檔案、Wireshark的封包抓取、Zeek (Bro)偵測資料、TCP連線腳本紀錄。也提供PRADS(來自Snort、OSSEC)、SANCP資訊的樞紐。
        - 事件處理(Event Handling):管理警報使用，內建七個分類。

    - 工作流程管理(Workflow Management)/運行手冊自動化(Runbook Automation)
        - 目的：提升網路安全團隊的效率。強化人員的責任追蹤。確保所有警報都能被妥善處理。
        - 運作原理：HIDS軟體監控OS運作情形，其中一個工具是OSSEC，它的規則會偵測主機參數變化，觸發警報發送給Sguil。分析人員可以在Kibana中根據主機的IP位址，進一步分析這些警報。
            - 自動化查詢(Automated Queries)/plays/playbooks：自動搜尋那些傳統工具可能忽略的複雜安全事件。
            - 使用Sguil可解決中小型，但大型組織宜用第三方的工作流程管理系統。
            - Elasticsearch商業擴充套件X-Pack，可用多種管道發出警報。
            - Elastic.co也提供商業版本的Elastic SIEM產品。

> 常用字彙集

| 華語 | ENG |
| -- | -- |
| 有客製化的儀表板 | compose a custom dashboard |
| 為NSM資料提供視覺介面 | provide a visual interface to NSM data |
| 提供資訊分段 | provide a breakdown of the information |
| 儀錶板提供資料和視覺化結合 | Dashboards provide a combination of data and visualizations |
| 惡意軟體欺騙作業系統內核，使其允許自身進行系統呼叫 | malware fools an OS kernel into allowing it to make system calls |
| 搭配JSON，| Along with JSON,  |
| 通配符比對(用?或*) | wildcard matching |
| 正規表達式比對(用//) | regex matching |
| 模糊比對(用~) | fuzzy matching |
| 日誌被匯入Elasticsearch | Logs are ingested into Elasticsearch |
| 預設顯示最近24小時數據 | show the last 24 hours by default |
| 預建類別 | pre-built categories |
| 加速調查 | facilitate investigation |
| 在 ST 列中按滑鼠右鍵 | the right-clicking in the ST column |
| The functionalities concern ... ing | 這個功能涉及... |
| 提供一個方法 | provide a means of |
| 豐富的、情境化的訊息 | rich, contextualized information |
| 將 A 簡化到一定程度 | simplify A to a certain degree |
| 建立查詢 | construct queries |
| 將類似的警報關聯到同一條線上 | correlate similar alerts into a single line |
| 將資料轉換為通用格式 | Convert Data into a Universal Format |
| 同樣地，| Similarly,  |
| 以防萬一 | , just in case. |
| 符應需要 | suit the needs |
| 一項艱鉅的任務 | a daunting task |
| 外掛程式 | addons, plugins |
| 近乎即時地將資料傳送到 Elasticsearch | send data to Elasticsearch in near real time |
| 有...的能力 | with the ability to |
| 一個高度可擴展和模組化的框架 | a highly scalable and modular framework |
| 提供對異質網路的單一介面視圖 | provide a single interface view into a heterogeneous network |
| 感知網路中細微的異常或變化 | get a sense of subtle anomalies or changes in the network |
| 追蹤 | keep track of |
| 立即顯示的報表 | point-and-click reports |
| 混淆威脅行為者的 IP 位址混淆 | obfuscate threat actor IP addresses |
| 命令列介面 | command-line interface (CLI) |

## 7-3. 警報
- Security Onion suite (SO suite)
    - 開源軟體套裝。適用於Ubuntu Linux (部分元件由Cisco、Riverbend Technologies維持)。Network Security Monitoring (NSM)解決方案。
    - 單獨安裝、感測器、伺服器平台。
    - 三大主要功能：全部流量封包抓取，HIDS或NIDS啟用，警報分析工具。
        - 端點防護機制：主機檔案分析(host logfile analysis), 檔案整合監測(file integrity monitoring), 弱點偵測(vulnerability detection), 設定檔評估(configuration assessment), 事件回應(incident response)。部分另有聲譽型封鎖(reputation-based blocking), 支援GPU多工處理。
    - SO結構與功能(資料由下而上，部分列舉)
        - 分析(屬於tier 1資安分析人員工作)：Sguil (整合多方來源的警報，調查、分類、增強、停止，以特徵偵測，GUI workflow管理), WireShark (抓取封包), Kibana (使用Elasticsearch資料), Zeek (監測流量與深入分析)
        - 偵測：CapME (web, L4, HTTP/DNS/TCP交易), Snort (NIDS, ，以特徵和規則偵測), Zeek/Bro (NIDS，HTTP/DNS/TCP交易), OSSEC (HIDS), Wazuh (HIDS, 取代OSSEC), Suricata (NIDS, 亦可inline如IPS，多工處理，以特徵偵測), PADs (資產管理和監測).
        - 數據：PCAPS, Content Data, Transaction Data, Session Data, Host Logs, Alert Data,  Syslog Data (多個裝置), Metadata.

- 警報生成要素
    - 基本訊息：裝置或系統名+時戳+五元組(five tuples)有SrcIP, SPort, DstIP, DPort, Pr。
    - 其他訊息：允許或拒絕的流量、封包負載資訊、下載檔案hash值。
    - 觸發機制：事前定義的規則、特徵、不規則、行為。

- Snort規則結構
    - 規則表頭(rule header)：動作、協定、位址、埠、遮罩。
    - 規則選項(rule options)：以類似字典檔定義變數，msg:事件訊息、content:封包內容、reference:更多訊息、classtype:攻擊分類、sid:規則唯一值、rev:規則版本。
    - 引用規則位置(rule location)
    - 使用PulledPork自動從Snort.org下載更新規則。

- 如何評估警報？
    | 檢定後的結論 \ 母體情形  | H₀真 = 無攻擊(一如往常) | H₀假 = 有攻擊(異常發生) |
    | ----- | ----- | ----- |
    | 系統接受H₀ = 陰性 | True Negative。沒攻擊，系統正確忽略。 | False Negative。有攻擊，但系統沒偵測到。undetected incident。**型二錯誤(β)/漏報/偽陰性** |
    | 系統拒絕H₀ = 陽性| False Positive。沒攻擊，但系統誤判為有。benign trigger。**型一錯誤(α)/誤報/偽陽性** | True Positive。有攻擊，系統正確偵測到。actual incident |

    - 假設檢定
        - 虛無假設(H₀)：表示沒有顯著差異(或沒有事件、沒有變化)，此假設條件應有「等號」。eg. 法院判決-嫌疑人無罪。癌症檢測-檢測對象未患癌症。招募員工-應徵者不值得聘用。系統-沒有遭到攻擊(無威脅)。
        - 顯著水準(α)>=0.05：實際上虛無假設(H0)成立，我們仍有大於等於5%機率在數據看到顯著的測試結果。
        - 型一錯誤(α)/偽陽機率過高的分析報告表示結果不可信，對策是調低顯著水準。
        - 型二錯誤(β)/偽陰機率過高的分析讓人覺得沒什麼用處，對策是增加樣本數、降低資料變異數。
    - False表示undesirable或dangerous：
        - False positive (無攻擊卻有報)：良性事件(benign event)警報通報越少越好。網路偵測規則合法改變(legitimate changes)的初期會增加此項。
        - False negative (有攻擊卻未報)：用於回顧性分析(retrospective security analysis, RSA)，透過學習累積潛在的網路威脅情報。

    - deterministic analysis：已知既有弱點，分析者知道利用成功前面的每一步驟，描述出最差情形。
    - probabilistic analysis：使用即時分析、變數，估算利用的相似程度，預測每一步驟成功利用的可能性。


> 常用字彙集

| 華語 | ENG |
|---|---|
| 評估警報 | evaluate alerts |
| 決定對警報做些什麼處置 | decide what to do with alerts |
| 單獨安裝 | standalone installation |
| 擁有許多元件 | contains many components. |
| 簡化部署 | simplify the deployment |
| 一個容易讀取查看整個L4的方法 | an easy-to-read means of viewing an entire Layer 4 session. |
| 違反資安政策 | violate security policies |
| 被整合到SO。 | is integrated into Security Onion |
| 提供多樣的端點防護機制 | provide a broad spectrum of endpoint protection mechanisms |
| 額外功能 | additional features |
| 廣大的資料來源 | A wide variety of data sources |
| 直接從Sguil轉送到其他工具 | pivoting directly from Sguil to other tools |
| 其他工具超出課程範圍 | Other tools are beyond the scope of this course |
| 允許或拒絕 | permit or deny decision |
| 觸發警報 | trigger the alert |
| 解釋什麼觸發警報 | interpret what triggered the alert |
| 被寫在引號裡面 | is enclosed in parenthesis |
| 展現不同功能 | perform different functions | 
| 記錄不同事件 | record different events |
| 變得熟悉... | get familiar with ... |
| 製造一個惡意封包 | craft a malicious packet |
| 設定你專屬自己的防火牆規則 | configure your own customized firewall rule |
| 依據防火牆規則發布警報 | issue an alert based on the firewall rule |
| 新弱點被發現 | new vulnerabilities are discovered |
| 新威脅演化出來 | new threats evolve |
| 躲避偵測 | evade detection |
| 偵測惡用在他們發生時或已發生後 | detect exploits during or after they have occurred |
| 偵測規則應該過度保守為宜。| Detection rules should be overly conservative. |
| 解決警報佇列工作 | work through queues of alerts |
| 安全事件採用借鏡醫學診斷的方案進行分類。 | Security incidents are classified using a scheme borrowed from medical diagnostics. |
| 評估診斷程序 | evaluate diagnostic procedures |
| 發布警報，產生警報 | issue alerts, generate alerts |
| 將警報升級到更高級別 | escalate the alert to a higher level |
| 隔離損害、解決漏洞、減輕威脅並處理報告要求 | isolate the damage, address vulnerabilities, mitigate the threat, and deal with reporting requirements |
| 評估風險 | evaluate the risk |
| 評估緩解威脅的成本 | evaluate the cost of mitigating a threat |
| 進行利用 | carry out an exploit |
| 偵測利用並停止 | detect the exploit and stop it |
| 利用持續推進 | exploit proceeds any further |
| 欠缺知識或專業 | lack the knowledge or expertise |
| 變數產生某些作用  | variables are at play |